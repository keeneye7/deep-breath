<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Particle Cursor with Microphone Input</title>
  <style>
    body, html {
      margin: 0;
      overflow: hidden;
    }
    #app {
      position: absolute;
      width: 100%;
      height: 100%;
      background: black;
    }
  </style>
</head>
<body>
  <div id="app"></div>
  <script type="module">
    import { particlesCursor } from 'https://unpkg.com/threejs-toys@0.0.8/build/threejs-toys.module.cdn.min.js'

    const pc = particlesCursor({
      el: document.getElementById('app'),
      gpgpuSize: 512,
      colors: [0xaaaaaa, 0xcccccc],
      color: 0xbbbbbb,
      coordScale: 0.5,  // Halved
      noiseIntensity: 0.0005,  // Halved
      noiseTimeCoef: 0.00005,  // Halved
      pointSize: 1,
      pointDecay: 0.000625,  // Perishing speed halved
      sleepRadiusX: 88.5,  // Halved
      sleepRadiusY: 138.5,  // Halved
      sleepTimeCoefX: 0.0005,  // Halved
      sleepTimeCoefY: 0.001  // Halved
    })

    navigator.mediaDevices.getUserMedia({ audio: true, video: false })
      .then(stream => {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const analyser = audioContext.createAnalyser();
        const microphone = audioContext.createMediaStreamSource(stream);
        const scriptProcessor = audioContext.createScriptProcessor(256, 1, 1);

        analyser.smoothingTimeConstant = 0.8;
        analyser.fftSize = 1024;

        microphone.connect(analyser);
        analyser.connect(scriptProcessor);
        scriptProcessor.connect(audioContext.destination);
        scriptProcessor.onaudioprocess = () => {
          const array = new Uint8Array(analyser.frequencyBinCount);
          analyser.getByteFrequencyData(array);

          let average = array.reduce((a, b) => a + b) / array.length;

          // Use average frequency data to influence particle movement
          pc.uniforms.uCoordScale.value = 0.25 + average / 1024;  // Halved
          pc.uniforms.uNoiseIntensity.value = 0.001 + average / 2048;  // Halved
          pc.uniforms.uPointSize.value = 1.25 + average / 256;  // Particle size range halved
          
          // Update particles' noise time coefficient to create streamlined movement
          pc.uniforms.uNoiseTimeCoef.value = 0.00005 + average / 200000;  // Halved
        };
      })
      .catch(error => console.error(error));

    document.body.addEventListener('click', () => {
      pc.uniforms.uColor.value.set(Math.random() * 0xffffff)
      pc.uniforms.uCoordScale.value = 0.0005 + Math.random() * 1  // Halved
      pc.uniforms.uNoiseIntensity.value = 0.00005 + Math.random() * 0.0005  // Halved
      pc.uniforms.uPointSize.value = 1.25 + Math.random() * 2.5  // Particle size range halved
    })
  </script>
</body>
</html>
